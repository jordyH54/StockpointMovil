@page "/usuarios"
@inject Stockpoint.Shared.Models.GetClient ApiClient
@inject Stockpoint.Shared.Services.AppStateService AppState
@inject Stockpoint.Shared.Services.CatalogService CatalogService
@using Stockpoint.Shared.Models
@using Stockpoint.Shared.Services
@using System.Text.Json
@using System.Timers

<style>
    .editarDiv{
        background: var(--primary-color);
    }
</style>

<div class="mobile-friendly-container">
    <!-- Encabezado mejorado -->
    @if (!string.IsNullOrEmpty(recoveryMessage))
    {
        <div class="alert @recoveryMessageClass alert-dismissible fade show mb-3 py-2">
            <div class="d-flex align-items-center">
                <i class="bi @(recoveryMessageClass.Contains("success") ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill") me-2"></i>
                <span>@recoveryMessage</span>
                <button type="button" class="btn-close ms-auto" @onclick="ClearMessage"></button>
            </div>
        </div>
    }
    <div class="d-flex justify-content-between align-items-center mb-3 p-2  rounded">
        <h1 class="m-0 ">
            <i class="bi bi-people-fill me-2"></i>Administración de Usuarios
        </h1>
        
    </div>

    <!-- SmartSelect con mejor diseño -->
    <div class="mb-3">
        
        <div style=" margin:4px;">
            <div class="d-flex justify-content-end gap-2 ">
            <label class="form-label fw-bold  subtitulos">Seleccionar Usuario</label>
            <button @onclick="CrearUsuario" class="btn btn-my-primary" >
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-square" viewBox="0 0 16 16">
                    <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z" />
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />
                    </svg> Nuevo
            </button>
            </div>
        </div>
        <SmartSelect Class="form-select form-select-sm"
                     catalogo="Usuarios"
                     @bind-SelectedValue="selectedUsuario"
                     @ref="usuarioSelect"
                     DefaultPrompt="Seleccione un usuario"
                     EmptyMessage="No hay usuarios disponibles" />
    </div>

    <!-- Mensajes de estado mejorados -->
    

    <!-- Formulario de usuario optimizado para móvil -->
    @if (hasValor)
    {
        <div class="card border-0 shadow-sm">
            <div class="card-header editarDiv text-white py-2">
                <h5 class="m-0">
                    <i class="bi @(itemSeleccionado2.idUsuario == 0 ? "bi-person-plus" : "bi-person-gear") me-2"></i>
                    @(itemSeleccionado2.idUsuario == 0 ? "Nuevo Usuario" : "Editar Usuario")
                </h5>
            </div>

            <div class="card-body p-3">
                <div class="row g-2">
                    <!-- ID (solo en edición) -->
                    @if (itemSeleccionado2.idUsuario > 0)
                    {
                        <div class="col-12">
                            <label class="form-label small text-muted">ID Usuario</label>
                            <input type="text" @bind="itemSeleccionado2.idUsuario"
                                   class="form-control form-control-sm bg-light" readonly />
                        </div>
                    }

                    <!-- Campos del formulario -->
                    <div class="col-12 col-md-6">
                        <label class="form-label small fw-bold">Nombre Completo</label>
                        <input type="text" @bind="itemSeleccionado2.Nombre"
                               class="form-control form-control-sm" />
                    </div>

                    <div class="col-12 col-md-6">
                        <label class="form-label small fw-bold">Correo Electrónico</label>
                        <input type="email" @bind="itemSeleccionado2.CorreoElectronico"
                               class="form-control form-control-sm" />
                    </div>

                    <div class="col-12 col-md-6">
                        <label class="form-label small fw-bold">Contraseña</label>
                        <div class="input-group input-group-sm">
                            <input type="@(showPassword ? "text" : "password")" @bind="itemSeleccionado2.ClaveAcceso"
                                   class="form-control" />
                            <button class="btn btn-outline-secondary" type="button"
                                    @onclick="TogglePasswordVisibility">
                                <i class="bi @(showPassword ? "bi-eye-slash" : "bi-eye")"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-12 col-md-6">
                        <label class="form-label small fw-bold">Teléfono Principal</label>
                        <input type="tel" @bind="itemSeleccionado2.Telefono1"
                               class="form-control form-control-sm" />
                    </div>

                    <div class="col-12 col-md-6">
                        <label class="form-label small fw-bold">Teléfono Secundario</label>
                        <input type="tel" @bind="itemSeleccionado2.Telefono2"
                               class="form-control form-control-sm" />
                    </div>
                    
                        @* <div class="col-md-6 mb-2">
                            <label class="form-label fw-bold">ID Rol</label>
                            <input type="text" @bind="itemSeleccionado2.idRol"
                                   class="form-control form-control-sm" />
                        </div> *@
                    <div class="col-md-6 mb-2">
                        <label class="form-label fw-bold">Rol</label>
                        <SmartSelect Class="form-select form-select-sm"
                                     catalogo="Rol"
                                     @bind-SelectedValue="selectedUsuarioRol"
                                     @ref="usuarioSelectRol"
                                     DefaultPrompt="Seleccione un Rol"
                                     EmptyMessage="No hay usuarios disponibles" />
                    </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label fw-bold">Estatus</label>
                            <SmartSelect Class="form-select form-select-sm"
                                         catalogo="Estatus del usuario"
                                         @bind-SelectedValue="selectedUsuarioEstatus"
                                         @ref="usuarioSelectEstatus"
                                         DefaultPrompt="Seleccione un estatus"
                                         EmptyMessage="No hay usuarios disponibles" />
                        </div>
                    
                    <!-- Campos de solo lectura -->
                    
                </div>

                <!-- Botones de acción -->
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <button class="btn btn-danger px-4 py-2" @onclick="cancelar">
                        Cancelar
                    </button>
                    <button class="btn btn-my-primary px-4 py-2" @onclick="GuardarUsuario">
                        Guardar
                    </button>
                </div>
            </div>
        </div>
    }
</div>
@code {
    #region VARIABLES DE ESTADO
    // Variables existentes
    private SmartSelect usuarioSelect, usuarioSelectRol, usuarioSelectEstatus;
    private string _selectedUsuario, _selectedUsuarioRol, _selectedUsuarioEstatus;
    private List<vwUsuario> elementosUsuario = new();
    private vwUsuario itemSeleccionado2 = new();
    private bool hasValor = false;
    private Timer messageTimer;
    private int messageTimeout = 5000;
    private string recoveryMessage = string.Empty;
    private string recoveryMessageClass = "alert-info";
    private bool showPassword = false;
    #endregion

    #region PROPIEDADES DE SELECCIÓN
    // Propiedad selectedUsuario (mantener igual)
    private string selectedUsuarioEstatus
    {
        get => _selectedUsuarioEstatus;
        set
        {
            if (_selectedUsuarioEstatus != value)
            {
                _selectedUsuarioEstatus = value;
                if (itemSeleccionado2 != null && int.TryParse(value, out int idEstatus))
                {
                    itemSeleccionado2.idEstatus = idEstatus;
                }
            }
        }
    }

    private string selectedUsuario
    {
        get => _selectedUsuario;
        set
        {
            if (_selectedUsuario != value)
            {
                _selectedUsuario = value;
                if (!string.IsNullOrEmpty(value))
                {
                    obtenerinfoUsuario().ConfigureAwait(false);
                }
            }
        }
    }

    private string selectedUsuarioRol
    {
        get => _selectedUsuarioRol;
        set
        {
            if (_selectedUsuarioRol != value)
            {
                _selectedUsuarioRol = value;
                if (itemSeleccionado2 != null && int.TryParse(value, out int idRol))
                {
                    itemSeleccionado2.idRol = idRol;
                }
            }
        }
    }
    #endregion

    #region MÉTODOS DEL CICLO DE VIDA
    protected override async Task OnInitializedAsync()
    {
        messageTimer = new Timer(messageTimeout);
        messageTimer.Elapsed += (sender, e) => ClearMessage();
        messageTimer.AutoReset = false;
        AppState.CurrentPage = "Usuario";
    }
    #endregion

    #region 'MÉTODOS DE INTERFAZ DE USUARIO'
    // Método para alternar visibilidad de contraseña
    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
        StateHasChanged();
    }

    // Método para recargar el SmartSelect
    private async Task RefreshSmartSelect()
    {
        if (usuarioSelect != null)
        {
            await usuarioSelect.ReloadCatalogAsync();
            await usuarioSelect.ResetSelection();
            StateHasChanged();
        }
    }

    private void cancelar()
    {
        showPassword = false;
        RefreshSmartSelect();
        hasValor = false;
        StateHasChanged();
    }

    private async void ClearMessage()
    {
        await InvokeAsync(() =>
        {
            recoveryMessage = string.Empty;
            recoveryMessageClass = string.Empty;
            StateHasChanged();
        });
    }

    private void SetTemporaryMessage(string message, string messageClass)
    {
        recoveryMessage = message;
        recoveryMessageClass = messageClass;
        messageTimer.Stop();
        messageTimer.Start();
        StateHasChanged();
    }
    #endregion

    #region OPERACIONES CRUD - USUARIOS
    // Método GuardarUsuario modificado
    public async Task GuardarUsuario()
    {
        // if (string.IsNullOrEmpty(selectedUsuario)) return;

        var clientHandler = new GetClient
        {
            R = new cResul
            {
                metodos = "obtGetClient",
                Token = "tu_token_si_es_necesario",
                modulo = "Usuarios"
            }
        }.GetClientConfigured();

        var recoveryRequest = new
        {
            idUsuario = itemSeleccionado2.idUsuario,
            Nombre = itemSeleccionado2.Nombre,
            CorreoElectronico = itemSeleccionado2.CorreoElectronico,
            ClaveAcceso = itemSeleccionado2.ClaveAcceso,
            Telefono1 = itemSeleccionado2.Telefono1,
            Telefono2 = itemSeleccionado2.Telefono2,
            idRol = int.Parse(selectedUsuarioRol),
            idEstatus = int.Parse(selectedUsuarioEstatus),
            R = new cResul
            {
                modulo = AppState.CurrentPage,
                metodos = "Guardar",
                Token = AppState.SysToken
            }
        };

        try
        {
            var response = await clientHandler.PostAsJsonAsync("WebServices/UsuariosA", recoveryRequest);
            if (response.IsSuccessStatusCode)
            {
                hasValor = false;
                SetTemporaryMessage("Usuario guardado exitosamente", "alert-success");
                if (usuarioSelect != null)
                    await usuarioSelect.ReloadCatalogAsync(); // Recargar el SmartSelect
            }
            else
            {
                SetTemporaryMessage("Error al guardar el usuario", "alert-danger");
            }
            RefreshSmartSelect();
        }
        catch (Exception ex)
        {
            SetTemporaryMessage($"Error: {ex.Message}", "alert-danger");
        }
    }

    public async Task obtenerinfoUsuario()
    {
        if (string.IsNullOrEmpty(selectedUsuario)) return;
        hasValor = true;

        var clientHandler = new GetClient
        {
            R = new cResul
            {
                metodos = "obtGetClient",
                Token = "tu_token_si_es_necesario",
                modulo = "Usuarios"
            }
        }.GetClientConfigured();

        var recoveryRequest = new
        {
            idUsuario = int.Parse(selectedUsuario),
            R = new cResul
            {
                modulo = AppState.CurrentPage,
                metodos = "Cargar",
                Token = AppState.SysToken
            }
        };

        try
        {
            var response = await clientHandler.PostAsJsonAsync("WebServices/UsuariosA", recoveryRequest);
            elementosUsuario = response.IsSuccessStatusCode
                ? await response.Content.ReadFromJsonAsync<List<vwUsuario>>()
                : new List<vwUsuario>();

            if (elementosUsuario.Any())
            {
                itemSeleccionado2 = new vwUsuario
                {
                    idUsuario = elementosUsuario[0].idUsuario,
                    Nombre = elementosUsuario[0].Nombre,
                    CorreoElectronico = elementosUsuario[0].CorreoElectronico,
                    ClaveAcceso = elementosUsuario[0].ClaveAcceso,
                    Telefono1 = elementosUsuario[0].Telefono1,
                    Telefono2 = elementosUsuario[0].Telefono2,
                    idRol = elementosUsuario[0].idRol,
                    idEstatus = elementosUsuario[0].idEstatus,
                    Rol = elementosUsuario[0].Rol,
                    Estatus = elementosUsuario[0].Estatus
                };
                selectedUsuarioRol = elementosUsuario[0].idRol.ToString();
                selectedUsuarioEstatus = elementosUsuario[0].idEstatus.ToString();

                // Forzar la actualización de los selects
                if (usuarioSelectRol != null)
                    await usuarioSelectRol.SetSelectedValue(selectedUsuarioRol);
                if (usuarioSelectEstatus != null)
                    await usuarioSelectEstatus.SetSelectedValue(selectedUsuarioEstatus);
            }
        }
        catch (Exception ex)
        {
            SetTemporaryMessage($"Error: {ex.Message}", "alert-danger");
        }

        StateHasChanged();
    }

    public async Task CrearUsuario()
    {
        hasValor = true;
        itemSeleccionado2 = new vwUsuario
        {
            idUsuario = 0,
            Nombre = string.Empty,
            CorreoElectronico = string.Empty,
            ClaveAcceso = string.Empty,
            Telefono1 = string.Empty,
            Telefono2 = string.Empty,
            idRol = 0,
            idEstatus = 0,
            Rol = string.Empty,
            Estatus = string.Empty
        };

        selectedUsuarioRol = "";
        selectedUsuarioEstatus = "";
        StateHasChanged();
    }
    #endregion
}
@* @code {
    // Variables existentes
    private SmartSelect usuarioSelect, usuarioSelectRol, usuarioSelectEstatus;
    private string _selectedUsuario, _selectedUsuarioRol, _selectedUsuarioEstatus;
    private List<vwUsuario> elementosUsuario = new();
    private vwUsuario itemSeleccionado2 = new();
    private bool hasValor = false;
    private Timer messageTimer;
    private int messageTimeout = 5000;
    private string recoveryMessage = string.Empty;
    private string recoveryMessageClass = "alert-info";
    private bool showPassword = false;

    // Propiedad selectedUsuario (mantener igual)

    private string selectedUsuarioEstatus
    {
        get => _selectedUsuarioEstatus;
        set
        {
            if (_selectedUsuarioEstatus != value)
            {
                _selectedUsuarioEstatus = value;
                if (itemSeleccionado2 != null && int.TryParse(value, out int idEstatus))
                {
                    itemSeleccionado2.idEstatus = idEstatus;
                }
            }
        }
    }

    private string selectedUsuario
    {
        get => _selectedUsuario;
        set
        {
            if (_selectedUsuario != value)
            {
                _selectedUsuario = value;
                if (!string.IsNullOrEmpty(value))
                {
                    obtenerinfoUsuario().ConfigureAwait(false);
                }
            }
        }
    }




    private string selectedUsuarioRol
    {
        get => _selectedUsuarioRol;
        set
        {
            if (_selectedUsuarioRol != value)
            {
                _selectedUsuarioRol = value;
                if (itemSeleccionado2 != null && int.TryParse(value, out int idRol))
                {
                    itemSeleccionado2.idRol = idRol;
                }
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        messageTimer = new Timer(messageTimeout);
        messageTimer.Elapsed += (sender, e) => ClearMessage();
        messageTimer.AutoReset = false;
        AppState.CurrentPage = "Usuario";
    }

    // Método para alternar visibilidad de contraseña
    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
        StateHasChanged();
    }

    // Método para recargar el SmartSelect
    private async Task RefreshSmartSelect()
    {
        if (usuarioSelect != null)
        {
            await usuarioSelect.ReloadCatalogAsync();
            await usuarioSelect.ResetSelection();
            StateHasChanged();
        }
    }

    // Método GuardarUsuario modificado
    public async Task GuardarUsuario()
    {
        // if (string.IsNullOrEmpty(selectedUsuario)) return;

        var clientHandler = new GetClient
            {
                R = new cResul
                {
                    metodos = "obtGetClient",
                    Token = "tu_token_si_es_necesario",
                    modulo = "Usuarios"
                }
            }.GetClientConfigured();

        var recoveryRequest = new
        {
            idUsuario = itemSeleccionado2.idUsuario,
            Nombre = itemSeleccionado2.Nombre,
            CorreoElectronico = itemSeleccionado2.CorreoElectronico,
            ClaveAcceso = itemSeleccionado2.ClaveAcceso,
            Telefono1 = itemSeleccionado2.Telefono1,
            Telefono2 = itemSeleccionado2.Telefono2,
            idRol = int.Parse(selectedUsuarioRol),
            idEstatus = int.Parse(selectedUsuarioEstatus),
            R = new cResul
                {
                    modulo = AppState.CurrentPage,
                    metodos = "Guardar",
                    Token = AppState.SysToken
                }
        };

        try
        {
            var response = await clientHandler.PostAsJsonAsync("WebServices/UsuariosA", recoveryRequest);
            if (response.IsSuccessStatusCode)
            {
                hasValor = false;
                SetTemporaryMessage("Usuario guardado exitosamente", "alert-success");
                if (usuarioSelect != null)
                    await usuarioSelect.ReloadCatalogAsync(); // Recargar el SmartSelect
            }
            else
            {
                SetTemporaryMessage("Error al guardar el usuario", "alert-danger");
            }
        }
        catch (Exception ex)
        {
            SetTemporaryMessage($"Error: {ex.Message}", "alert-danger");
        }
    }

    // Métodos existentes (mantener igual)
    private void cancelar()
    {
        hasValor = false;
        StateHasChanged();
    }

    private async void ClearMessage()
    {
        await InvokeAsync(() =>
        {
            recoveryMessage = string.Empty;
            recoveryMessageClass = string.Empty;
            StateHasChanged();
        });
    }

    public async Task obtenerinfoUsuario()
    {
        if (string.IsNullOrEmpty(selectedUsuario)) return;
        hasValor = true;

        var clientHandler = new GetClient
            {
                R = new cResul
                {
                    metodos = "obtGetClient",
                    Token = "tu_token_si_es_necesario",
                    modulo = "Usuarios"
                }
            }.GetClientConfigured();

        var recoveryRequest = new
        {
            idUsuario = int.Parse(selectedUsuario),
            R = new cResul
                {
                    modulo = AppState.CurrentPage,
                    metodos = "Cargar",
                    Token = AppState.SysToken
                }
        };

        try
        {
            var response = await clientHandler.PostAsJsonAsync("WebServices/UsuariosA", recoveryRequest);
            elementosUsuario = response.IsSuccessStatusCode
                ? await response.Content.ReadFromJsonAsync<List<vwUsuario>>()
                : new List<vwUsuario>();

            if (elementosUsuario.Any())
            {
                itemSeleccionado2 = new vwUsuario
                    {
                        idUsuario = elementosUsuario[0].idUsuario,
                        Nombre = elementosUsuario[0].Nombre,
                        CorreoElectronico = elementosUsuario[0].CorreoElectronico,
                        ClaveAcceso = elementosUsuario[0].ClaveAcceso,
                        Telefono1 = elementosUsuario[0].Telefono1,
                        Telefono2 = elementosUsuario[0].Telefono2,
                        idRol = elementosUsuario[0].idRol,
                        idEstatus = elementosUsuario[0].idEstatus,
                        Rol = elementosUsuario[0].Rol,
                        Estatus = elementosUsuario[0].Estatus
                    };
                selectedUsuarioRol = elementosUsuario[0].idRol.ToString();
                selectedUsuarioEstatus = elementosUsuario[0].idEstatus.ToString();

                // Forzar la actualización de los selects
                if (usuarioSelectRol != null)
                    await usuarioSelectRol.SetSelectedValue(selectedUsuarioRol);
                if (usuarioSelectEstatus != null)
                    await usuarioSelectEstatus.SetSelectedValue(selectedUsuarioEstatus);
            }
        }
        catch (Exception ex)
        {
            SetTemporaryMessage($"Error: {ex.Message}", "alert-danger");
        }

        StateHasChanged();
    }

    public async Task CrearUsuario()
    {
        hasValor = true;
        itemSeleccionado2 = new vwUsuario
            {
                idUsuario = 0,
                Nombre = string.Empty,
                CorreoElectronico = string.Empty,
                ClaveAcceso = string.Empty,
                Telefono1 = string.Empty,
                Telefono2 = string.Empty,
                idRol = 0,
                idEstatus = 0,
                Rol = string.Empty,
                Estatus = string.Empty
            };

        selectedUsuarioRol = "";
        selectedUsuarioEstatus = "";
        StateHasChanged();
    }

    private void SetTemporaryMessage(string message, string messageClass)
    {
        recoveryMessage = message;
        recoveryMessageClass = messageClass;
        messageTimer.Stop();
        messageTimer.Start();
        StateHasChanged();
    }
} *@