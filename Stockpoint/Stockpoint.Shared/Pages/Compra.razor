@page "/compra"
@inject Stockpoint.Shared.Models.GetClient ApiClient
@inject Stockpoint.Shared.Services.AppStateService AppState
@using Stockpoint.Shared.Models
@using System.Timers
@using System.Text.Json
@using static Stockpoint.Shared.Pages.Venta
@inject IJSRuntime JSRuntime
<style>
    .form-container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    /* Estilos específicos para la tabla de adeudos en móviles */
    /* Contenedor principal para adeudos */
    .adeudos-container {
        width: 100%;
        margin-top: 10px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    /* Contenedor de scroll */
    .adeudos-scroll-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        flex: 1;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        background-color: white;
    }

    .adeudos-table2 {
        min-width: 316px;
    }

        .adeudos-table2 th {
            background-color: var(--primary-color);
            color: black;
            position: sticky;
            top: 0;
            font-size: 0.9rem;
            padding: 1vh;
        }
    /* Tabla de adeudos */
    .adeudos-table {
        width: 100%;
        min-width: 600px; /* Ancho mínimo para asegurar todas las columnas */
        border-collapse: collapse;
    }

        .adeudos-table th,
        .adeudos-table td {
            padding: 1vh;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
        }

        .adeudos-table th {
            background-color: var(--primary-color);
            color: black;
            position: sticky;
            top: 0;
            font-size: 0.9rem;
            padding: 1vh;
        }

        .adeudos-table td {
            font-size: 0.82rem;
            color: #333;
        }

            /* Tamaños de columnas específicos */
            .adeudos-table td:nth-child(1) {
                width: 50px;
            }
            /* Columna # */
            .adeudos-table td:nth-child(2) {
                width: 90px;
            }
            /* Fecha */
            .adeudos-table td:nth-child(3) {
                min-width: 80px;
                max-width: 100px;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            /* Cliente */
            .adeudos-table td:nth-child(4) {
                width: 60px;
            }
            /* Estatus */
            .adeudos-table td:nth-child(5),
            .adeudos-table td:nth-child(6) {
                width: 90px;
                text-align: right;
                padding-right: 12px;
            }

    /* Estilos responsivos */
    @@media (max-width: 600px) {
        .adeudos-table th,
        .adeudos-table td {
            padding: 8px 4px;
            font-size: 0.75rem;
        }

            .adeudos-table td:nth-child(1) {
                width: 40px;
            }

            .adeudos-table td:nth-child(2) {
                width: 80px;
            }

            .adeudos-table td:nth-child(3) {
                min-width: 100px;
                max-width: 120px;
            }

            .adeudos-table td:nth-child(4) {
                width: 70px;
            }

            .adeudos-table td:nth-child(5),
            .adeudos-table td:nth-child(6) {
                width: 80px;
                padding-right: 8px;
            }
    }

    /* Badges para estatus */
    .badge {
        font-size: 0.7rem;
        padding: 4px 6px;
        border-radius: 4px;
        font-weight: 500;
    }

    .bg-success {
        background-color: #28a745 !important;
    }

    .bg-warning {
        background-color: #ffc107 !important;
        color: #212529 !important;
    }

    .bg-danger {
        background-color: #dc3545 !important;
    }

    .bg-info {
        background-color: #17a2b8 !important;
    }

    .bg-secondary {
        background-color: #6c757d !important;
    }

    /* Estilos para el botón de acción */
    .cmdEditarCatalogo {
        cursor: pointer;
        color: #007bff;
        font-size: 1rem;
        display: flex;
        justify-content: center;
    }

    /* Mejoras para dispositivos muy pequeños */





    /* Contenedor principal optimizado */
    .mobile-container {
        padding: 10px;
        height: 90vh;
        display: flex;
        flex-direction: column;
    }

    /* Tabla responsive */
    .table-container {
        flex: 1;
        overflow: auto;
        margin-top: 10px;
    }

    .mobile-table {
        width: 100%;
        min-width: 100%;
        table-layout: fixed;
        border-collapse: separate;
        border-spacing: 0;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

        .mobile-table th,
        .mobile-table td {
            padding: 12px 8px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-table th {
            background-color: var(--primary-color);
            color: black;
            position: sticky;
            top: 0;
            text-align: center;
            font-size: 0.9rem;
        }

        .mobile-table td {
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }

            /* Columnas con anchos específicos */
            .mobile-table th:nth-child(1),
            .mobile-table td:nth-child(1) {
                width: 60px; /* Acción */
            }

            .mobile-table th:nth-child(2),
            .mobile-table td:nth-child(2) {
                width: calc(70% - 60px); /* Producto */
            }

            .mobile-table th:nth-child(3),
            .mobile-table td:nth-child(3) {
                width: 30%; /* Código */
            }

    /* Resto de estilos se mantienen igual */
    .header-title {
        color: white;
        text-align: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
        font-family: 'Times New Roman', serif; /* Fuente con cursiva natural */
        font-style: italic;
    }

    .search-container {
        display: flex;
        align-items: center;
        background: white;
        border-radius: 25px;
        padding: 8px 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .search-input {
        flex: 1;
        border: none;
        background: transparent;
        padding: 8px;
        font-size: 16px;
        outline: none;
    }

    .search-button {
        background: var(--primary-color);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }

    .action-button {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }

    .mi-svg-azul path {
        fill: var(--primary-color);
    }

    .product-name {
        font-weight: 500;
        color: #333;
    }

    .product-code {
        color: #666;
    }

    .invalid {
        border-color: #e74c3c;
        box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
    }

    .valid {
        border-color: #2ecc71;
        box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
    }
    /* Estilos para el carrito */
    .cart-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: white;
        color: var(--primary-color);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        border: 2px solid var(--primary-color);
    }

    .cart-button-container {
        position: relative;
        display: inline-block;
    }

    .cart-table {
        position: absolute;
        right: 0;
        top: 100%;
        z-index: 1000;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        width: 320px;
        max-height: 400px;
        min-height: 560px;
        overflow-y: auto;
        display: none;
    }

        .cart-table.show {
            display: block;
        }

    .cart-actions button {
        min-width: 30px;
        padding: 2px 5px;
        margin: 0 2px;
    }

    .clear-cart-btn {
        position: absolute;
        top: -8px;
        right: 28px; /* Cambiado de -5px a 15px para moverlo a la izquierda */
        background: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 2px solid #ff4444;
        z-index: 1;
    }

        .clear-cart-btn:hover {
            background: #ffeeee;
        }

</style>




@if (!string.IsNullOrEmpty(recoveryMessage))
    {
        <div class="alert @recoveryMessageClass alert-dismissible fade show mb-3 py-2">
            <div class="d-flex align-items-center">
                <i class="bi @(recoveryMessageClass.Contains("success") ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill") me-2"></i>
                <span>@recoveryMessage</span>
                <button type="button" class="btn-close ms-auto" @onclick="ClearMessage"></button>
            </div>
        </div>
    }
    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner-container">
                <div class="spinner"></div>
            </div>
            <p class="loading-text">Cargando @mensajeloding...</p>
    </div>
    }
    else
    {
        <div class="d-flex justify-content-between" style="width: 100%; gap: 10px; padding-bottom:2vh">
            <button class="btn btn-light btnFV flex-grow-1 " @onclick="JFrameC">
                <svg xmlns="http://www.w3.org/2000/svg" style="margin-left:10%" width="16" height="16" fill="currentColor" class="bi bi-basket-fill" viewBox="0 0 16 16">
                    <path d="M5.071 1.243a.5.5 0 0 1 .858.514L3.383 6h9.234L10.07 1.757a.5.5 0 1 1 .858-.514L13.783 6H15.5a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5H15v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9H.5a.5.5 0 0 1-.5-.5v-2A.5.5 0 0 1 .5 6h1.717zM3.5 10.5a.5.5 0 1 0-1 0v3a.5.5 0 0 0 1 0zm2.5 0a.5.5 0 1 0-1 0v3a.5.5 0 0 0 1 0zm2.5 0a.5.5 0 1 0-1 0v3a.5.5 0 0 0 1 0zm2.5 0a.5.5 0 1 0-1 0v3a.5.5 0 0 0 1 0zm2.5 0a.5.5 0 1 0-1 0v3a.5.5 0 0 0 1 0z" />
                </svg>
            </button>
            <button class="btn btn-my-primary btnFE flex-grow-1" @onclick="JFrameCB">
                <svg xmlns="http://www.w3.org/2000/svg" style="margin-left:10%" width="16" height="16" fill="currentColor" class="bi bi-archive-fill" viewBox="0 0 16 16">
                    <path d="M12.643 15C13.979 15 15 13.845 15 12.5V5H1v7.5C1 13.845 2.021 15 3.357 15zM5.5 7h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1M.8 1a.8.8 0 0 0-.8.8V3a.8.8 0 0 0 .8.8h14.4A.8.8 0 0 0 16 3V1.8a.8.8 0 0 0-.8-.8z" />
                </svg>
            </button>
        </div>
    @if (VFCompra)
    {
        <h1>Compra</h1>
        <div class="search-container">
            <input type="text"
                   class="search-input"
                   placeholder="Buscar por nombre o código..."
                   @bind="TextoBusqueda"
                   @bind:event="oninput" />


            <div class="cart-button-container">
                @if (CartItemsCount > 0)
                {
                    <span class="cart-badge">@CartItemsCount</span>
                    <span class="clear-cart-btn" @onclick:preventDefault @onclick="() => ClearCart()" title="Vaciar carrito">
                        <svg height="16px" width="16px" viewBox="0 0 24 24" fill="#ff4444">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                        </svg>
                    </span>
                }
                <button class="search-button" @onclick="ToggleCart">
                    <svg class="mi-svg-carritoT" height="20px" width="20px" viewBox="0 0 294.038 294.038" fill="#ffffff">
                        <g>
                            <path d="m289.513,86.441c-3.481-5.22-12.181-10.441-19.142-10.441l-224.475-15.661-8.701-27.842c0-1.74-1.74-5.22-5.22-5.22l-20.882-6.96c-3.48-1.74-8.701,0-10.441,5.22-1.74,3.48 0,8.701 5.22,10.441l17.401,5.22 8.701,29.582 34.802,120.068c2.488,9.083 7.761,16.548 14.617,21.943-7.796,6.404-12.894,15.974-12.894,26.78 0,19.141 15.661,34.802 34.802,34.802s34.802-15.661 34.802-34.802c0-6.351-1.844-12.251-4.855-17.401h67.151c-3.01,5.151-4.855,11.05-4.855,17.401 0,19.141 15.661,34.802 34.802,34.802 19.159,0 34.802-15.661 34.802-34.802 0-9.379-3.793-17.889-9.884-24.17 8.526-5.429 14.913-13.851 16.862-24.553l20.882-81.786c1.725-8.7 1.725-15.661-3.495-22.621zm-186.21,170.532c-10.441,0-17.401-6.96-17.401-17.401s6.96-17.401 17.401-17.401c8.701,0 17.401,6.96 17.401,17.401s-6.961,17.401-17.401,17.401zm127.028,0c-10.441,0-17.401-6.96-17.401-17.401s6.96-17.401 17.401-17.401c10.458,0 17.401,6.96 17.401,17.401s-6.96,17.401-17.401,17.401zm26.102-69.605c-1.462,8.805-9.223,16.026-18.88,18.184-2.332-0.505-4.733-0.783-7.222-0.783-3.602,0-7.013,0.713-10.284,1.74h-106.461c-3.271-1.027-6.682-1.74-10.284-1.74-0.818,0-1.584,0.191-2.384,0.244-7.552-2.906-14.147-9.762-16.775-17.645l-31.321-107.888 215.775,15.661c3.48,0 5.22,1.74 6.96,3.48 1.74,1.74 1.74,5.22 1.74,6.96l-20.864,81.787z" />
                        </g>
                    </svg>

                </button>



                @if (showCart)
                {
                    <div class="cart-table show">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in cartItems)
                                {
                                    <tr>
                                        <td>@item.ProductName</td>
                                        <td>@item.Quantity</td>
                                        <td>$@(item.CostoXCaja* item.Quantity)</td>
                                        <td class="cart-actions">
                                            <button @onclick="() => ModifyQuantity(item, 1)" class="btn btn-sm btn-primary">+</button>
                                            <button @onclick="() => ModifyQuantity(item, -1)" class="btn btn-sm btn-primary">-</button>
                                            <button @onclick="() => RemoveItem(item)" class="btn btn-sm btn-danger my-1">X</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2"><strong>Total:</strong></td>
                                    <td colspan="2"><strong>$@Total.ToString()</strong></td>


                                </tr>
                                <tr>
                                    <td colspan="2"><strong>Paga:</strong></td>
                                    <td colspan="2">
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input @bind="Paga"
                                                   type="number" class="form-control" placeholder="0.00" step="0.01">
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2"><strong>Cambio:</strong></td>
                                    <td colspan="2"><strong>$@Cambio</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                        <div class="d-flex justify-content-end">
                            <SmartSelect Class="form-select form-select-sm m-1"
                                         catalogo="Proovedor"
                                         @bind-SelectedValue="selectedCliente"
                                         @ref="clienteSelect"
                                         DefaultPrompt="Proovedor"
                                         EmptyMessage="No hay Proovedor disponibles" />
                            <SmartSelect Class="form-select form-select-sm m-1"
                                         catalogo="Tipo de pago"
                                         @bind-SelectedValue="selectedTP"
                                         @ref="tpSelect"
                                         DefaultPrompt="Pago"
                                         EmptyMessage="No hay usuarios disponibles" />
                            <button @onclick="() => ActualizarExis()"
                                    class=" btn btn-my-primary mx-2 my-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cash-coin" viewBox="0 0 16 16" style="vertical-align: middle; margin-top: -2px;">
                                    <path fill-rule="evenodd" d="M11 15a4 4 0 1 0 0-8 4 4 0 0 0 0 8m5-4a5 5 0 1 1-10 0 5 5 0 0 1 10 0" />
                                    <path d="M9.438 11.944c.047.596.518 1.06 1.363 1.116v.44h.375v-.443c.875-.061 1.386-.529 1.386-1.207 0-.618-.39-.936-1.09-1.1l-.296-.07v-1.2c.376.043.614.248.671.532h.658c-.047-.575-.54-1.024-1.329-1.073V8.5h-.375v.45c-.747.073-1.255.522-1.255 1.158 0 .562.378.92 1.007 1.066l.248.061v1.272c-.384-.058-.639-.27-.696-.563h-.668zm1.36-1.354c-.369-.085-.569-.26-.569-.522 0-.294.216-.514.572-.578v1.1zm.432.746c.449.104.655.272.655.569 0 .339-.257.571-.709.614v-1.195z" />
                                    <path d="M1 0a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h4.083q.088-.517.258-1H3a2 2 0 0 0-2-2V3a2 2 0 0 0 2-2h10a2 2 0 0 0 2 2v3.528c.38.34.717.728 1 1.154V1a1 1 0 0 0-1-1z" />
                                    <path d="M9.998 5.083 10 5a2 2 0 1 0-3.132 1.65 6 6 0 0 1 3.13-1.567" />
                                </svg>Liquidar
                            </button>
                        </div>
                    </div>
                }
                @if (showCart)
                {
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 999;"
                         @onclick="() => { showCart = false; StateHasChanged(); }"></div>
                }
            </div>
        </div>
        <div class="table-container">
            @if (productosCompletos.Any())
            {
                <table class="mobile-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Producto</th>
                            <th>Código</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in productosCompletos)
                        {
                            <tr>
                                <td>
                                    <div class="action-button" @onclick="@(() => AgregarProducto(item.idProducto))" title="Editar">
                                        <svg class="mi-svg-azul" height="20px" width="20px" viewBox="0 0 294.873 294.873">
                                            <g>
                                                <path d="M287.373,37.98h-46.046c-8.789,0-17.546,6.626-19.936,15.085l-12.438,44.023 c-1.423-0.396-2.92-0.625-4.478-0.625H99.761c-5.056-22.543-25.217-39.442-49.263-39.442C22.653,57.021,0,79.675,0,107.518 c0,25.479,18.974,46.601,43.532,50.006c-0.011,0.329-0.009,0.661,0.024,0.998l2.61,26.457c0.925,9.373,9.027,16.715,18.446,16.715 h115.462c8.827,0,17.546-6.675,19.85-15.195l14.439-53.397c0.001-0.001,0.001-0.003,0.001-0.003l21.46-75.955 c0.583-2.061,3.359-4.163,5.502-4.163h46.046c4.142,0,7.5-3.357,7.5-7.5S291.515,37.98,287.373,37.98z M15,107.518 c0-19.573,15.924-35.497,35.498-35.497s35.497,15.924,35.497,35.497c0,19.573-15.924,35.497-35.497,35.497S15,127.092,15,107.518z M185.445,182.583c-0.551,2.036-3.262,4.111-5.371,4.111H64.612c-1.646,0-3.356-1.549-3.518-3.188l-2.578-26.135 c22.774-3.65,40.497-22.58,42.31-45.908h103.648c0.072,0,0.137,0.003,0.193,0.007c-0.011,0.056-0.025,0.119-0.044,0.188 L185.445,182.583z" />
                                                <path d="M86.504,210.236c-12.863,0-23.328,10.465-23.328,23.328c0,12.863,10.465,23.328,23.328,23.328 c12.863,0,23.329-10.465,23.329-23.328C109.833,220.701,99.367,210.236,86.504,210.236z M86.504,241.892 c-4.592,0-8.328-3.736-8.328-8.328c0-4.592,3.736-8.328,8.328-8.328c4.592,0,8.329,3.736,8.329,8.328 C94.833,238.156,91.096,241.892,86.504,241.892z" />
                                                <path d="M160.472,210.236c-12.863,0-23.328,10.465-23.328,23.328c0,12.863,10.465,23.328,23.328,23.328 c12.863,0,23.328-10.465,23.328-23.328C183.8,220.701,173.335,210.236,160.472,210.236z M160.472,241.892 c-4.592,0-8.328-3.736-8.328-8.328c0-4.592,3.736-8.328,8.328-8.328c4.592,0,8.328,3.736,8.328,8.328 C168.8,238.156,165.064,241.892,160.472,241.892z" />
                                                <path d="M57.996,126.094v-11.075h11.078c4.142,0,7.5-3.357,7.5-7.5s-3.358-7.5-7.5-7.5H57.996V88.94 c0-4.143-3.358-7.5-7.5-7.5s-7.5,3.357-7.5,7.5v11.078H31.921c-4.142,0-7.5,3.357-7.5,7.5s3.358,7.5,7.5,7.5h11.075v11.075 c0,4.143,3.358,7.5,7.5,7.5S57.996,130.236,57.996,126.094z" />
                                            </g>
                                        </svg>
                                    </div>
                                </td>
                                <td class="product-name">@item.Productos</td>
                                <td class="product-name">@item.Codigo</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    }
    @if (VFCompraB)
    {
        <h1>Bitacora de Compras</h1>

        <div class="d-flex justify-content-between mb-2">
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-my-primary btn-sm" @onclick="ToggleFilters" style="font-size:18px;">
                    <i class="fas fa-filter"></i> Filtros
                </button>
            </div>
        </div>

        <!-- Contenedor de filtros desplegable -->
        <div class="filters-container" style="@(showFilters ? "display: block;" : "display: none;") ">
            <div class="row g-3" style="margin-top:4%; background:var(--primary-color); border-radius:0.5vh;">
                <!-- Filtros existentes... -->
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <label class="form-label">Cliente</label>
                    <SmartSelect Class="form-select"
                                 catalogo="Proovedor"
                                 @bind-SelectedValue="selectedClienteE"
                                 @ref="clienteSelectE" />
                </div>
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <label class="form-label">Fecha Inicial</label>
                    <input type="date"
                           class="form-control"
                           @bind="fechaInicio"
                           @bind:format="yyyy-MM-dd" />
                </div>

                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <label class="form-label">Fecha Final</label>
                    <input type="date"
                           class="form-control"
                           @bind="fechaFin"
                           @bind:format="yyyy-MM-dd" />
                </div>
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <label class="form-label">Tipo de Pago</label>
                    <SmartSelect Class="form-select"
                                 catalogo="Tipo de pago"
                                 @bind-SelectedValue="seleccionadoTP"
                                 @ref="tipoPSelect" />
                </div>




                <div class="col-12 text-end mt-2">
                    <button class="btn mb-2" @onclick="ApplyFilters" style="background:var(--primary-light)">
                        <i class="fas fa-filter"></i> Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>
        <div class="adeudos-container">
            @if (elementosTabla.Any())
            {
                <div class="adeudos-scroll-container">
                    <table class="adeudos-table">
                        <thead>
                            <tr>
                                <th class="text-center" style="width:10%">idCompra</th>
                                <th class="text-center" style="width:10%">Fecha</th>
                                <th class="text-center" style="width:10%">Proveedor</th>
                                <th class="text-center" style="width:10%">Precio Total</th>
                                <th class="text-center" style="width:15%">Tipo Pago</th>
                                <th class="text-center" style="width:20%">Productos y Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in elementosTabla)
                            {
                                <tr>
                                    <td class="text-center">
                                        @item.idCompra
                                    </td>
                                    <td>@item.Fecha.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                    <td>@(item.Proveedor)</td>
                                    <td class="text-center">@item.PrecioTotal</td>
                                    <td class="text-center">@item.TipoPago</td>
                                    <td class="text-center">@((MarkupString)(item.ProductosConCantidad?.Replace(";  ", "<br/>") ?? ""))</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info text-center">
                    No se encontraron adeudos con los filtros seleccionados
                </div>
            }
        </div>
    }

}
@code {
    #region atributos
    private List<vwtblCompraDetallada> elementosTabla = new();
    private void ToggleFilters() => showFilters = !showFilters;
    private bool showFilters = false;
    public bool isLoading = false;
    public string recoveryMessage = string.Empty;
    public string recoveryMessageClass = string.Empty;
    public string mensajeloding = string.Empty;
    public bool VFCompra = true;
    public bool VFCompraB = false;
    private bool showCart = false;
    private List<CartItem> cartItems = new();
    public int CartItemsCount => cartItems.Sum(i => i.Quantity);

    public double? Paga { get; set; }
    public double? Total => cartItems.Sum(i => i.CostoXCaja * i.Quantity);
    public double? Cambio => Paga - Total;

    private string _textoBusqueda = string.Empty;
    private Timer messageTimer;
    SmartSelect clienteSelect, tpSelect, clienteSelectE, tipoPSelect, unidadSelect;


    private List<vwProducto> productosCompletos = new();

    private string _selectedCliente, _selectedTP, _selectedClienteE, _seleccionadoTP;
    private string selectedCliente
    {
        get => _selectedCliente;
        set
        {
            if (_selectedCliente != value)
            {
                _selectedCliente = value;
            }
        }
    }
    private DateTime _fechaInicio = DateTime.Today.AddDays(-7);
    private DateTime _fechaFin = DateTime.Today;
    private string selectedTP
    {
        get => _selectedTP;
        set
        {
            if (_selectedTP != value)
            {
                _selectedTP = value;
            }
        }
    }

    public string selectedClienteE
    {
        get => _selectedClienteE;
        set
        {
            if (_selectedClienteE != value)
            {
                _selectedClienteE = value;
            }
        }
    }
    public string seleccionadoTP
    {
        get => _seleccionadoTP;
        set
        {
            if (_seleccionadoTP != value)
            {
                _seleccionadoTP = value;
            }
        }
    }

    public DateTime fechaInicio
    {
        get => _fechaInicio;
        set
        {
            if (_fechaInicio != value)
            {
                _fechaInicio = value;
            }
        }
    }

    public DateTime fechaFin
    {
        get => _fechaFin;
        set
        {
            if (_fechaFin != value)
            {
                _fechaFin = value;
            }
        }
    }

    public string TextoBusqueda
    {
        get => _textoBusqueda;
        set
        {
            if (_textoBusqueda != value)
            {
                _textoBusqueda = value;
                FiltrarProductos();
            }
        }
    }
    private class CartItem
    {
        public int ProductId { get; set; }
        public string ProductName { get; set; }
        public string ProductCode { get; set; }
        public double? CostoXCaja { get; set; }
        public int Quantity { get; set; }
    }
    #endregion
    #region navegación en Frames
    public async Task JFrameC()
    {
        isLoading = true;
        mensajeloding = "Compra";
        VFCompra = true;
        VFCompraB = false;
        await cargarProductos();
    }
    public async Task JFrameCB()
    {
        selectedClienteE = string.Empty;
        seleccionadoTP = string.Empty;
        isLoading = true;
        mensajeloding = "Bitacora Compra";
        VFCompra = false;
        VFCompraB = true;
        await CargarElementosCatalogo();
    }
    #endregion

    #region Metodos
    protected override async Task OnInitializedAsync()
    {

        AppState.CurrentPage = "Compra"; // Actualiza el nombre en el layout
        await cargarProductos();
    }
    public async Task cargarProductos()
    {

        var clientHandler = new GetClient
        {
            R = new cResul
            {
                metodos = "obtGetClient",
                Token = "tu_token_si_es_necesario",
                modulo = "Usuarios"
            }
        }.GetClientConfigured();

        var recoveryRequest = new
        {
            R = new cResul
            {
                modulo = AppState.CurrentPage,
                metodos = "Cargar",
                Token = AppState.SysToken
            }
        };

        try
        {
            var response = await clientHandler.PostAsJsonAsync("WebServices/ProductosA", recoveryRequest);
            if (response.IsSuccessStatusCode)
            {
                productosCompletos = await response.Content.ReadFromJsonAsync<List<vwProducto>>() ?? new List<vwProducto>();
                isLoading = false;
            }
            else
            {

                SetTemporaryMessage("Error al cargar Productos", "alert-danger");
            }
        }
        catch (Exception ex)
        {

            SetTemporaryMessage($"Error al cargar Productos: {ex.Message}", "alert-danger");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();

        }
    }




    public async Task AgregarProducto(int id)
    {
        try
        {
            var producto = productosCompletos.FirstOrDefault(p => p.idProducto == id);
            if (producto == null) return;

            var existingItem = cartItems.FirstOrDefault(i => i.ProductId == id);

            if (existingItem != null)
            {
                existingItem.Quantity++;
            }
            else
            {
                cartItems.Add(new CartItem
                {
                    ProductId = producto.idProducto,
                    ProductName = producto.Productos,
                    ProductCode = producto.Codigo,
                    CostoXCaja = producto.CostoXCaja,
                    Quantity = 1
                });
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            SetTemporaryMessage($"Error al agregar producto: {ex.Message}", "alert-danger");
        }
    }
    #endregion


    private async Task ActualizarExis()
    {
        if (string.IsNullOrEmpty(selectedCliente))
        {
            SetTemporaryMessage("Agrega un Proovedor", "alert-danger");
            return;
        }

        if (string.IsNullOrEmpty(selectedTP))
        {
            SetTemporaryMessage("Agrega un tipo de pago", "alert-danger");
            return;
        }

        if (cartItems.Count == 0)
        {
            SetTemporaryMessage("El carrito está vacío", "alert-danger");
            return;
        }

        if (Paga == null || Paga < 0)
        {
            Paga = 0;

        }
        try
        {
            var existencia = cartItems.Select(exis => new vwProducto
            {
                idProducto = exis.ProductId,
                cantidad = exis.Quantity
            }).ToList();

            var permisos2 = string.Join(",", existencia
            .Select(item => $"{item.idProducto}:{item.cantidad}"));


            var request = new
            {

                idProveedor = int.Parse(selectedCliente),
                Token = AppState.SysToken,
                idTipoPago = int.Parse(selectedTP),
                PrecioTotal = Total,
                Paga = Paga,
                idProductos = permisos2,
                Existencias = existencia,

                R = new cResul
                {
                    modulo = AppState.CurrentPage,
                    metodos = "Guardar",
                    Token = AppState.SysToken,
                }
            };

            var clientHandler = new GetClient
            {
                R = new cResul
                {
                    metodos = "obtGetClient",
                    Token = AppState.SysToken,
                    modulo = "Usuarios"
                }
            }.GetClientConfigured();

            var response = await clientHandler.PostAsJsonAsync("WebServices/Compra", request);

            if (response.IsSuccessStatusCode)
            {

                showCart = false;
                cartItems.Clear();
                existencia.Clear();
                Paga = 0;
                selectedCliente = string.Empty;
                selectedTP = string.Empty;
                await cargarProductos();
            }
            else
            {
                SetTemporaryMessage("Error: no se pudo guardar venta", "alert-danger");
            }
        }
        catch (Exception ex)
        {
            SetTemporaryMessage($"Error: {ex.Message}", "alert-danger");
            Console.WriteLine($"Error completo: {ex.ToString()}");
        }
        finally
        {
            selectedCliente = string.Empty;
            selectedTP = string.Empty;
            StateHasChanged();
        }


    }
    private void FiltrarProductos()
    {
        productosCompletos = string.IsNullOrWhiteSpace(TextoBusqueda)
            ? new List<vwProducto>(productosCompletos)
            : productosCompletos
                .Where(p =>
                    (p.Productos?.ToLower().Contains(TextoBusqueda.ToLower()) ?? false) ||
                    (p.Codigo?.ToLower().Contains(TextoBusqueda.ToLower()) ?? false))
                .ToList();
    }
    private async void ClearMessage()
    {
        await InvokeAsync(() =>
        {
            recoveryMessage = string.Empty;
            recoveryMessageClass = string.Empty;
            StateHasChanged();
        });
    }
    private void SetTemporaryMessage(string message, string messageClass)
    {
        recoveryMessage = message;
        recoveryMessageClass = messageClass;
        messageTimer.Stop();
        messageTimer.Start();
        StateHasChanged();
    }
    private void ClearCart()
    {
        cartItems.Clear();
        StateHasChanged();
    }
    private void ToggleCart()
    {
        selectedCliente = string.Empty;
        selectedTP = string.Empty;
        showCart = !showCart;
    }
    private void ModifyQuantity(CartItem item, int change)
    {
        item.Quantity += change;
        if (item.Quantity <= 0) cartItems.Remove(item);
        StateHasChanged();
    }

    private void RemoveItem(CartItem item)
    {
        cartItems.Remove(item);
        StateHasChanged();
    }
    public void Dispose()
    {
        messageTimer?.Dispose();
    }
    private async Task ApplyFilters()
    {
        showFilters = !showFilters;

        await CargarElementosCatalogo();
    }
    private async Task CargarElementosCatalogo()
    {
        try
        {
            var requestData = new
            {
                FechaInicial = fechaInicio.ToString("yyyy/MM/dd"),
                FechaFinal = fechaFin.AddDays(1).AddSeconds(-1).ToString("yyyy/MM/dd"),
                idProveedor = selectedClienteE,
                idTipoPago = selectedTP,
                R = new cResul
                {
                    modulo = AppState.CurrentPage,
                    metodos = "BCompra",
                    Token = AppState.SysToken,
                }
            };

            using var client = new GetClient
            {
                R = new cResul
                {
                    metodos = "obtGetClient",
                    Token = AppState.SysToken,
                    modulo = AppState.CurrentPage
                }
            }.GetClientConfigured();

            var response = await client.PostAsJsonAsync("WebServices/Compra", requestData);

            if (response.IsSuccessStatusCode)
            {
                var options = new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true,
                    Converters = { new DotNetDateConverter() }
                };

                var jsonString = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<VentaResponse>(jsonString, options);
                elementosTabla = result?.Compra ?? new List<vwtblCompraDetallada>();
                isLoading = false;
            }
            else
            {
                await OnInitializedAsync();
            }
        }
        catch (Exception ex)
        {
            SetTemporaryMessage($"Error al cargar datos: {ex.Message}", "alert-danger");
            Console.WriteLine($"Error completo: {ex.ToString()}");
        }
        finally
        {
            selectedClienteE = string.Empty;
            StateHasChanged();
        }
    }
}